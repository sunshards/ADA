{% extends 'base.html' %}

{% block css %}
    <link rel="stylesheet" href="{{ url_for('static', filename='chat/chat.css') }}">
{% endblock %}

{% block js %}
    <!-- FIRST: Set user variables for JavaScript -->
    <script type="text/javascript">
        // Set global variables from Flask template data
        window.userId = "{{ user_id|default('')|tojson|safe }}";
        window.username = "{{ username|default('Anonymous')|tojson|safe }}";
        window.avatar = "{{ url_for('static', filename='temp/avatar_animal_00001.png')|tojson|safe }}";
        
        // If you have different avatars per user, use this:
        {% if avatar %}
            window.avatar = "{{ url_for('static', filename=avatar)|tojson|safe }}";
        {% else %}
            window.avatar = "{{ url_for('static', filename='temp/avatar_animal_00001.png')|tojson|safe }}";
        {% endif %}
        
        // Debug: log user info
        console.log('Chat initialized for:', window.username);
    </script>

    <script src="https://cdn.socket.io/4.5.0/socket.io.min.js"></script>
    <script type="text/javascript" src="{{ url_for('static', filename='chat/chat.js') }}"></script>
{% endblock %}

{% block content %}

<main class="d-flex flex-column vh-100">
    <nav class="navbar navbar-expand bg-body-tertiary shadow-sm sticky-top">
        <div class="container-fluid">
            <h4 class="navbar-text mx-auto">Campaign</h4>
        </div>
    </nav>

    <div class="container-fluid w-100 h-100">
        <div class="row w-100 h-100">
            <div class="col-7 d-flex h-100 align-items-center">
                <div class="card h-75 flex-grow-1 mb-5 ms-5">
                    <!-- Header -->
                    <div class="card-header bg-info text-white text-center">
                        <h4 class="fw-bold">Live chat</h4>
                    </div>

                    <!-- Messages -->
                    <div class="card-body overflow-y-scroll" >
                        
                        {% for message in messages %}
                        
                            {% if message["type"] == "out" %}
                            <!-- Incoming Message -->
                            <div class="d-flex mb-3">
                                <img
                                src="{{ url_for('static', filename='temp/avatar_animal_00001.png') }}"
                                class="rounded-circle me-2" 
                                width="40" 
                                height="40" 
                                alt="avatar"
                                >
                                <div class="message message-in">
                                    Hello world
                                </div>
                            </div>

                            {% else %}
                            <!-- Outgoing Message -->
                            <div class="d-flex flex-row-reverse mb-3">
                                <img
                                src="{{ url_for('static', filename='temp/avatar_animal_00002.png') }}"
                                class="rounded-circle me-2" 
                                width="40" 
                                height="40" 
                                alt="avatar"
                                >
                                <div class="message message-out me-2">
                                    Hello world
                                </div>
                            </div>

                            {% endif %}

                        {% endfor %}
                        
                    </div>

                    <!-- Form -->
                    <div class="card-footer bg-body-tertiary">
                        <div class="input-group">
                            <textarea class="form-control no-resize" 
                                    id="messageInput" 
                                    rows="2" 
                                    placeholder="Type your message... Press Enter to send"></textarea>
                            <button class="btn btn-primary" id="sendButton" type="button">
                                <i data-feather="send"></i>
                            </button>
                        </div>
                        <div class="small text-muted mt-1">
                            <span id="typingIndicator" class="d-none">Someone is typing...</span>
                        </div>
                    </div>

                </div>
            </div>

            <div class="col-5 d-flex justify-content-center mt-2 player-column">
                <div class="player-box d-flex flex-column align-items-center p-3 rounded-3 overflow-y-scroll flex-grow-1 mx-3">
                    <h4>Players</h4>

                    {% for player in players %}
                    <div class="mb-4 player-card rounded-1">
                        <img 
                        src="{{ url_for('static', filename='temp/avatar_animal_00001.png') }}" 
                        alt="Avatar 1"
                        class="card-img-top player-avatar"
                        >
                        <div class="">
                            <span class="player-name">{{player["username"]}}</span>
                            <div class="progress lifebar-container" role="lifebar" aria-label="Lifebar" aria-valuenow="{{player["percentage"]}}" aria-valuemin="0" aria-valuemax="100">
                                <div class="progress-bar lifebar-health" style="width: {{player["percentage"]}}%;"></div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}

                </div>
            </div>
        </div>
    </div>

</main>





{% endblock %}

